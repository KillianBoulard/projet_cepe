library(ggplot2)
library(dplyr)
library(tidyr)
library(geosphere)
library(tidyverse)
library(purrr)

library(rlang)

library(caret)




#travail
setwd("C:/Users/bigas/Documents/laurent/formation_cepe/projets_MachineLearning/data")


#taff
setwd("C:/Users/vhle524/OneDrive - LA POSTE GROUPE/Documents/projetcepe/data")



data<-readRDS("dataset.rds", refhook = NULL)


table (data$annee)

data_clean<-data %>% mutate(  incendie  = ifelse(Y==0,"incendie=0","incendie=1") ) %>% 
  filter (annee != 2022)

data_incendies <-data_clean%>% filter(Y==1)

library(leaflet)

pal <- colorFactor(
  palette = 'Accent',
  domain = data_incendies$annee
)

mean_surface<-mean(data_incendies$superficie)
mediane_surface<-median(data_incendies$superficie)

data_incendies_majeurs<- data_incendies %>%
  filter(superficie>mediane_surface)

###############################################################################################


#ok###############################################
ggplot(data_incendies) +
  aes(x = superficie) +
  geom_density(color="darkblue", fill="lightblue") +
  geom_vline(aes(xintercept=mean(superficie)),
             color="darkblue", linetype="dashed", size=1)
  ggtitle("superficie brulée") +
  xlab("superficie") +
  ylab("Densité") 


ggplot(data_incendies, aes(x=superficie)) + geom_histogram() + 
  geom_vline(aes(xintercept=mean(superficie)),color="blue", linetype="dashed", size=1) +
  xlab("superficie") +
  ylab("effectifs") +
facet_wrap(annee ~ .)
  
#ok###############################################
ggplot(data_incendies, aes(x=superficie)) + 
  geom_histogram(aes(y=..density..), alpha=1, binwidth = 30,colour="lightblue", fill="lightblue")+
  geom_density(alpha=.2, fill="blue") 



#ok###############################################
ggplot(data_clean, aes(x=temperature_23_g)) + 
  geom_histogram(aes(y=..density..), colour="darkblue", fill="lightblue")+
  geom_density(alpha=.2, fill="lightblue") + 
  facet_wrap(incendie ~ .)

#ok###############################################
ggplot(data_clean, aes(x=temperature_14_g)) + 
  geom_histogram(aes(y=..density..), colour="darkblue", fill="lightblue")+
  geom_density(alpha=.2, fill="lightblue") + 
  facet_grid(incendie ~ .)




ggplot(data_clean, aes(x=temperature_14_m_1)) + 
  geom_histogram(aes(y=..density..), colour="darkblue", fill="lightblue")+
  geom_density(alpha=.2, fill="lightblue") +
  facet_grid(incendie ~ .)

ggplot(data_clean, aes(x=temperature_23_m_1)) + 
  geom_histogram(aes(y=..density..), colour="darkblue", fill="lightblue")+
  geom_density(alpha=.2, fill="lightblue") +
  facet_grid(incendie ~ .)


ggplot(data_clean, aes(x=pression_niveau_mer_23_m_1)) + 
  geom_histogram(aes(y=..density..), colour="darkblue", fill="lightblue")+
  geom_density(alpha=.2, fill="lightblue") +
  facet_grid(incendie ~ .)


ggplot(data_incendies, aes(x=superficie)) + 
  geom_histogram(aes(y=..density..), colour="darkblue", fill="lightblue")+
  geom_density(alpha=.2, fill="lightblue") +
  facet_grid(annee ~ .)
####################################################################################################



leaflet(data_incendies) %>% addTiles() %>%
  setView(-2.213749, 46.227638,zoom=5) %>%
  addCircles(lng = ~lat, lat = ~long, weight = 1,
             radius = ~sqrt(superficie) * 50, popup = ~paste("superficie :", superficie,"code insee :",code_insee,annee),
             color = ~pal(annee), fillOpacity = 1) 


data_incendies_majeurs<- data_incendies %>%
  filter(superficie>mediane_surface)
  
leaflet(data_incendies_majeurs)  %>% 
  addCircles(lng = ~lat, lat = ~long, weight = 1,
             radius = ~sqrt(superficie) *60, 
             popup = ~paste(sep = "<br/>",
                            "<b>Surface (hectares) </b>", superficie,
                            "<b>Commune </b>",code_insee,
                            "<b>Année </b>",annee),
             color = ~pal(annee), fillOpacity = 0.75) %>%
  addLegend("bottomright", pal = pal, values = ~annee,
            title = " Répartition des incendies majeurs",
            labFormat = labelFormat(prefix = " "),
            opacity = 1
  ) %>% 
  addProviderTiles("OpenStreetMap.France") %>%
  setView(2.792276, 46.461114,zoom=5)     


####################################################################################################
  
  
#evolution de la temperature moyenne
ggplot(data=data_incendies_majeurs, aes(x=annee, y=temperature_14_g, group=1)) +
  geom_line()+
  geom_point()


data_group_by<-data_clean %>% select(annee,mois,code_insee,
                                     Y,id_station,superficie,temperature_23_m_1,
                                     temperature_14_m_1,temperature_23_m_12,temperature_14_m_12,
                                     point_rosee_14_m_1,point_rosee_14_m_12,
                                     humidite_14_m_1,humidite_14_m_12
                                     ) %>% 
  group_by(annee,mois,Y) %>%
  mutate(mean_temp_23_m_1 =mean(temperature_23_m_1),
         mean_temp_14_m_1 =mean(temperature_14_m_1),
         mean_temp_23_m_12 =mean(temperature_23_m_12),
         mean_temp_14_m_12 =mean(temperature_14_m_12),
         mean_point_rosee_14_m_1=mean(point_rosee_14_m_1),
         mean_point_rosee_14_m_12=mean(point_rosee_14_m_12),
         mean_humidite_14_m_1=mean(humidite_14_m_1),
         mean_humidite_14_m_12=mean(humidite_14_m_12)
         ) %>%
  distinct(annee,mois,Y,mean_temp_23_m_1,mean_temp_14_m_1,mean_temp_23_m_12,
           mean_temp_14_m_12,mean_point_rosee_14_m_1,mean_point_rosee_14_m_12,
           mean_humidite_14_m_1,mean_humidite_14_m_12)
  
  
ggplot(data=data_group_by, aes(x=mois, y=mean_temp_14_g, group=Y)) +
  geom_line()+
  geom_point() +facet_wrap(annee~.)

#bonne version###
######################################################################################"
ggplot(data_group_by, aes(x=mois, y=mean_temp_14_m_1, group=Y)) +
  geom_line(aes(linetype=Y, color=Y))+
  geom_point(aes(color=Y))+
  theme(legend.position="top")+facet_wrap(annee~.)

ggplot(data_group_by, aes(x=mois, y=mean_temp_23_m_1, group=Y)) +
  geom_line(aes(linetype=Y, color=Y))+
  geom_point(aes(color=Y))+
  theme(legend.position="top")+facet_wrap(annee~.)

ggplot(data_group_by, aes(x=mois, y=mean_temp_14_m_12, group=Y)) +
  geom_line(aes(linetype=Y, color=Y))+
  geom_point(aes(color=Y))+
  theme(legend.position="top")+facet_wrap(annee~.)

ggplot(data_group_by, aes(x=mois, y=mean_temp_23_m_12, group=Y)) +
  geom_line(aes(linetype=Y, color=Y))+
  geom_point(aes(color=Y))+
  theme(legend.position="top")+facet_wrap(annee~.)


ggplot(data_group_by, aes(x=annee, y=mean_humidite_14_m_1, group=Y)) +
  geom_line(aes(linetype=Y, color=Y))+
  geom_point(aes(color=Y))+
  theme(legend.position="top")+facet_wrap(mois~.)


incendies<- read.csv(file="Incendies.csv",
                     col.names = c("annee","id","departement","code_insee",
                                   "nom_commune","date_alerte","origine_alerte","moyens_premiere_intervention",
                                   "surface_parcourue","surface_foret","surface_maquis",
                                   "surface_nat_autre_foret","surface_agricole","surface_autre_terre_boisee","surface_non_boisee_nat",
                                   "surface_non_boisee_art","suface_non_boisee","precision_surf","surface_feu_initiale",
                                   "voie_caross_proche","act_hab_proche","type_peupl","connaissance","source_enquete",
                                   "nature","interv_equipe","deces_bat_touches",
                                   "nb_deces","nb_bat_tot_detruit","nb_bat_part_detruit","hygrometrie",
                                   "v_moyenn_vent","dir_ven","temperature","precision_donnee","presence_contour_valide"),
                     header = T, 
                     sep=";",
                     encoding='UTF-8',skip = 6)



#incendies<-rbind(incendie20,incendie21)

#test

#correction des champs texte et transformation en vecteurs si nÃ©cessaire ##
incendies$origine_alerte <- gsub('IndÃÂ©terminÃÂ©', 'Indetermine', incendies$origine_alerte)
incendies$origine_alerte <- gsub('Ã©', 'e', incendies$origine_alerte)

incendies$precision_surf <- gsub('EstimÃÂ©es', 'Estimees', incendies$precision_surf)
incendies$precision_surf <- gsub('Ã©', 'e', incendies$precision_surf)

incendies$origine_alerte <- gsub('Pompiers prÃÂ©-positionnÃÂ©s', 'Pompiers pre-pos', incendies$origine_alerte)
incendies$origine_alerte <- gsub('Vigie-camÃÂ©ra', 'Vigie-cameras', incendies$origine_alerte)
incendies$origine_alerte <- gsub('Ã©', 'e', incendies$origine_alerte)

incendies$precision_surf <- gsub('MesurÃÂ©es', 'Mesuree', incendies$precision_surf )
incendies$precision_surf <- gsub('Ã©', 'e', incendies$precision_surf)

incendies$origine_alerte <-as.factor(incendies$origine_alerte)
incendies$precision_surf <-as.factor(incendies$precision_surf)
incendies$origine_alerte <-as.factor(incendies$origine_alerte)
incendies$precision_surf <-as.factor(incendies$precision_surf)
incendies$nature <-as.factor(incendies$nature)
incendies$annee<-as.factor(incendies$annee)
incendies$departement<-as.factor(incendies$departement)

incendies$date_alerte <-  as.Date(incendies$date_alerte,format = "%Y-%m-%d")




#################################################################


incendiestest<-incendies %>% filter (nature != "" & dir_ven !="")





ggplot(data=incendiestest,aes(x=nature,fill=dir_ven),position="dodge")+geom_bar()


ggplot(data=incendiestest,aes(x=annee,fill=nature),position="dodge")+geom_bar()



ggplot(incendiestest, aes(x = annee, fill=nature)) +
  geom_bar(position = position_dodge()) +
  geom_text(stat="count",
            aes(label=stat(count)), 
            position = position_dodge(width=1), 
            vjust=-0.5)+
  labs(title="répartition des incendies par nature", 
       x="Année de l'incendie", y = "nb incendies")
theme_economist_white()


ggplot(incendiestest, aes(x = annee, fill=origine_alerte)) +
  geom_bar(position = position_dodge()) +
  geom_text(stat="count",
            aes(label=stat(count)), 
            position = position_dodge(width=1), 
            vjust=-0.5)+
  labs(title="répartition des incendies par nature", 
       x="Année de l'incendie", y = "nb incendies")
theme_economist_white()


